{"version":3,"file":"parse.js","sourceRoot":"","sources":["../../../src/services/YouTube/parse.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Avoxel284 2022\n * Barbara Music Module / YouTube\n */\n\nimport { MusicPlaylist, MusicTrack, Service } from \"../../lib\";\nimport { getSecondsFromTime, getTimeFromSeconds } from \"../../lib/util\";\nimport { Audio } from \"../../lib\";\n\n/**\n * Parse a MusicTrack from YouTube video page data.\n * Some code was ripped from play-dl\n */\nexport function MusicTrackFromYouTube(data: any) {\n\tlet playerData = data\n\t\t.split(\"var ytInitialPlayerResponse = \")?.[1]\n\t\t?.split(\";</script>\")[0]\n\t\t.split(/;\\s*(var|const|let)\\s/)[0];\n\tif (!playerData) throw new Error(\"Failed to extract player data from YouTube video HTML\");\n\n\tlet initialData = data\n\t\t.split(\"var ytInitialData = \")?.[1]\n\t\t?.split(\";</script>\")[0]\n\t\t.split(/;\\s*(var|const|let)\\s/)[0];\n\tif (!initialData) throw new Error(\"Failed to extract initial data from YouTube video HTML\");\n\n\tplayerData = JSON.parse(playerData);\n\tinitialData = JSON.parse(initialData);\n\n\tif (playerData.playabilityStatus.status !== \"OK\") {\n\t\tif (playerData.playabilityStatus.status === \"CONTENT_CHECK_REQUIRED\") {\n\t\t\t// const cookies =\n\t\t\t// \tinitialData.topbar.desktopTopbarRenderer.interstitial?.consentBumpV2Renderer.agreeButton\n\t\t\t// \t\t.buttonRenderer.command.saveConsentAction;\n\t\t\t// if (cookies) {\n\t\t\t// \tObject.assign(cookieJar, {\n\t\t\t// \t\tVISITOR_INFO1_LIVE: cookies.visitorCookie,\n\t\t\t// \t\tCONSENT: cookies.consentCookie,\n\t\t\t// \t});\n\t\t\t// }\n\t\t\t// const updatedValues = await acceptViewerDiscretion(vid.videoId, cookieJar, body, true);\n\t\t\t// playerData.streamingData = updatedValues.streamingData;\n\t\t\t// initialData.contents.twoColumnWatchNextResults.secondaryResults = updatedValues.relatedVideos;\n\t\t} else if (playerData.playabilityStatus.status === \"LIVE_STREAM_OFFLINE\") {\n\t\t\tthrow new Error(\"Livestream has not begun yet\");\n\t\t\t// upcoming = true;\n\t\t\t// upcoming live stream\n\t\t} else\n\t\t\tthrow new Error(\n\t\t\t\t`Error occurred when scraping data from YouTube video: \\n${\n\t\t\t\t\tplayerData.playabilityStatus.errorScreen.playerErrorMessageRenderer?.reason.simpleText ??\n\t\t\t\t\tplayerData.playabilityStatus.errorScreen.playerKavRenderer?.reason.simpleText ??\n\t\t\t\t\tplayerData.playabilityStatus.reason\n\t\t\t\t}`\n\t\t\t);\n\t}\n\n\tconst videoData = playerData.videoDetails;\n\tconsole.log(\"video data\", videoData);\n\tconst musicData =\n\t\tinitialData.contents.twoColumnWatchNextResults.results.results.contents?.[1]\n\t\t\t?.videoSecondaryInfoRenderer?.metadataRowContainer?.metadataRowContainerRenderer?.rows;\n\n\t// TODO: yt music metadata\n\tif (musicData)\n\t\tmusicData.forEach((m: any) => {\n\t\t\t// console.log(m);\n\t\t\t// if (!m.metadataRowRenderer) return;\n\t\t\t// const row = m.metadataRowRenderer;\n\t\t\t// const title = row.title.simpleText ?? row.title.runs[0].text;\n\t\t\t// const contents = row.contents[0].simpleText ?? row.contents[0]?.runs?.[0]?.text;\n\t\t\t// const url =\n\t\t\t// \trow.contents[0]?.runs?.[0]?.navigationEndpoint?.commandMetadata?.webCommandMetadata.url;\n\t\t\t// if (music.length === 0) music.push({});\n\t\t\t// music[music.length - 1][title.toLowerCase()] = url\n\t\t\t// \t? { text: contents, url: `https://www.youtube.com${url}` }\n\t\t\t// \t: contents;\n\t\t\t// if (row.hasDividerLine) music.push({});\n\t\t});\n\n\tlet audios: Audio[] = [];\n\tif (playerData.streamingData.formats)\n\t\tplayerData.streamingData.formats.forEach((m: any) => {\n\t\t\treturn audios.push();\n\t\t});\n\t// let audios =\n\tconsole.log(playerData.streamingData.formats);\n\tconsole.log(playerData.streamingData.adaptiveFormats);\n\n\treturn new MusicTrack({\n\t\turl: `https://www.youtube.com/watch?v=${videoData.videoId}`,\n\t\tid: videoData.videoId,\n\t\tname: videoData.title,\n\t\t// description: videoData.shortDescription,\n\t\tduration: Number(videoData.lengthSeconds),\n\t\tthumbnail: videoData.thumbnail.thumbnails[0].url,\n\t\tauthor: {\n\t\t\tname: videoData.author,\n\t\t\tid: videoData.channelId,\n\t\t\turl: `https://www.youtube.com/channel/${videoData.channelId}`,\n\t\t\tavatar:\n\t\t\t\tinitialData.contents.twoColumnWatchNextResults.results?.results?.contents[1]\n\t\t\t\t\t?.videoSecondaryInfoRenderer?.owner?.videoOwnerRenderer?.thumbnail?.thumbnails?.[0],\n\t\t},\n\t\taudio: audios,\n\t\tlive: videoData.isLiveContent,\n\t\tservice: Service.youtube,\n\t\toriginalData: videoData,\n\t});\n}\n\n/**\n * Parse a MusicTrack from YouTube search page data.\n * Some code was ripped from play-dl\n */\nexport function MusicTrackFromYouTubeSearch(data: any) {\n\tif (!data || !data.videoRenderer) throw new Error(\"No data given\");\n\n\tconst channel = data.videoRenderer.ownerText.runs[0];\n\tconst duration = data.videoRenderer.lengthText;\n\tconst thumbnail =\n\t\tdata.videoRenderer.thumbnail.thumbnails[data.videoRenderer.thumbnail.thumbnails.length - 1];\n\tconst avatar =\n\t\tdata.videoRenderer.channelThumbnailSupportedRenderers.channelThumbnailWithLinkRenderer.thumbnail\n\t\t\t.thumbnails[0];\n\n\treturn new MusicTrack({\n\t\turl: `https://www.youtube.com/watch?v=${data.videoRenderer.videoId}`,\n\t\tname: data.videoRenderer.title.runs[0].text,\n\t\tid: data.videoRenderer.videoId,\n\t\t// description: data.videoRenderer.detailedMetadataSnippets?.[0].snippetText.runs.length\n\t\t// \t? data.videoRenderer.detailedMetadataSnippets[0].snippetText.runs\n\t\t// \t\t\t.map((run: any) => run.text)\n\t\t// \t\t\t.join(\"\")\n\t\t// \t: \"\",\n\t\tduration: duration ? getSecondsFromTime(duration.simpleText) : 0,\n\t\tthumbnail: thumbnail?.url,\n\t\tauthor: {\n\t\t\tid: channel.navigationEndpoint.browseEndpoint.browseId || null,\n\t\t\tname: channel.text || null,\n\t\t\turl: `https://www.youtube.com${\n\t\t\t\tchannel.navigationEndpoint.browseEndpoint.canonicalBaseUrl ||\n\t\t\t\tchannel.navigationEndpoint.commandMetadata.webCommandMetadata.url\n\t\t\t}`,\n\t\t\tavatar: avatar,\n\t\t},\n\t\tlive: duration ? false : true,\n\t\tservice: Service.youtube,\n\t\toriginalData: data.videoRenderer,\n\t});\n}\n\n/**\n * Parse a MusicPlaylist from YouTube playlist page.\n * Some code was ripped from play-dl\n */\nexport function MusicPlaylistFromYouTube(data: any) {\n\t// return new MusicPlaylist({\n\t// \turl: \"\",\n\t// \tservice: Service.youtube,\n\t// });\n}\n"]}